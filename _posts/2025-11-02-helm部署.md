---
title: Helm 部署
date: 2025-12-02 11:00:00 +0800
categories: [研发, 部署]
tags: [研发, 部署]
---

![](https://raw.githubusercontent.com/ShawnCheung/MyPic/img/img/202512021044139.png)
![](https://raw.githubusercontent.com/ShawnCheung/MyPic/img/img/202512021046172.png)

https://artifacthub.io/packages/search?ts_query_web=mysql&sort=relevance&page=1

## Helm 部署 MySQL — 扩充说明

下面把 Helm 部署 MySQL 的流程补充完整，包含如何在 Artifact Hub 选 chart、常见配置示例、安装/验证、备份/恢复、升级和回滚等实用步骤。

### 1) 在 Artifact Hub 选 Chart 的要点
- 维护情况：查看 chart 最后更新时间、维护者活跃度。
- 下载量 & 评分：反映社区使用度和稳定性。
- 文档 & values.yaml：确认 chart 支持自定义 root/password、持久化、资源限制、init scripts 等。
- 官方镜像来源与安全性：优先选择受信任来源（如 Bitnami、Official charts）。

示例搜索页面：
https://artifacthub.io/packages/search?ts_query_web=mysql&sort=relevance&page=1

### 2) 使用 Helm（示例：Bitnami MySQL）
安装 Helm repo 并部署最基础的 MySQL 实例（Helm 3）：

- 添加仓库并更新
```bash
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update
```

- 直接安装（生产请使用 values 文件）
```bash
kubectl create namespace db
helm install my-mysql bitnami/mysql --namespace db --set auth.rootPassword=MyRootPass123,auth.database=mydb
```

### 3) 使用 values.yaml 进行可重复、可审计的配置
创建 values 文件示例（保存为 mysql-values.yaml）：
```yaml
# mysql-values.yaml
auth:
  rootPassword: "MyRootPass123"
  username: "appuser"
  password: "AppUserPass"
  database: "appdb"

primary:
  persistence:
    enabled: true
    storageClass: "standard"   # 根据集群调整
    size: 8Gi

resources:
  limits:
    cpu: 1000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi

service:
  type: ClusterIP

initdbScripts: {}
# affinity/nodeSelector/tolerations 可加入以控制调度
```

使用 values 文件安装：
```bash
helm install my-mysql bitnami/mysql --namespace db -f mysql-values.yaml
```

### 4) 验证部署
- 检查资源状态：
```bash
kubectl get pods,svc,pvc -n db
kubectl describe pod <mysql-pod-name> -n db
```

- 连接到数据库（通过 kubectl port-forward 或在容器内）：
```bash
kubectl port-forward svc/my-mysql 3306:3306 -n db
# 然后本地使用 mysql 客户端连接
mysql -h 127.0.0.1 -P 3306 -u appuser -p
```
或进入 Pod：
```bash
kubectl exec -it $(kubectl get pod -n db -l app.kubernetes.io/name=mysql -o jsonpath='{.items[0].metadata.name}') -n db -- bash
mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SHOW DATABASES;"
```

### 5) 持久化与存储注意事项
- 确保 PVC 使用合适的 StorageClass（具备读写性能与快照能力）。
- 生产环境建议使用 PV 快照、备份策略或云存储快照结合备份工具（Velero / VolumeSnapshot）。
- 注意 IOPS、磁盘类型和恢复时间目标（RTO）。

### 6) 备份 / 恢复
- 逻辑备份（mysqldump）：
```bash
# 在 Pod 内备份
kubectl exec -n db <mysql-pod> -- mysqldump -u root -p"$MYSQL_ROOT_PASSWORD" --all-databases > all.sql
# 或 port-forward 后转到本地执行 mysqldump
```

- 二进制备份 / 磁盘快照：推荐与持久卷快照（VolumeSnapshots）或云卷快照配合使用。

- 恢复：
  - 从 mysqldump 导入
  - 从 PV 快照还原替换 PVC

### 7) 升级、回滚与删除
- 升级 chart（修改 values 或更新 chart 版本）：
```bash
helm repo update
helm upgrade my-mysql bitnami/mysql --namespace db -f mysql-values.yaml
```

- 回滚：
```bash
helm rollback my-mysql 1 # 回滚到指定 revision
```

- 删除（谨慎：会删除 PVC，仅当 persistence.enabled=false 或需保留 PV 时注意）：
```bash
helm uninstall my-mysql -n db
kubectl delete pvc -n db -l app.kubernetes.io/name=mysql
```

### 8) 生产环境建议 & 安全
- 使用 Kubernetes Secrets 存储密码或使用外部密钥管理（Vault/KMS）。
- 限制对数据库服务的访问（NetworkPolicy、私有网段）。
- 定期扫描镜像安全漏洞，并使用最小权限用户。
- 配置资源配额、监控（Prometheus / Datadog）与告警。

---

补充：如果你需要，我可以帮你
- 生成一个完整、适配你环境的 values.yaml；
- 将部署脚本写成 GitHub Actions 工作流；
- 写 CI/CD 中的 Helm 升级与回滚脚本。
